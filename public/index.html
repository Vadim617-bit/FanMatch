<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FanMatch ‚öΩ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="script.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-800 via-green-900 to-gray-900 text-white font-sans">

  <!-- üîó –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
  <header class="bg-black bg-opacity-80 text-white p-4 flex justify-between items-center shadow-lg">
    <h1 class="text-2xl font-bold tracking-wide">üèüÔ∏è FanMatch</h1>
    <nav class="flex gap-2 items-center">
      <a href="/" class="px-3 py-1 rounded hover:bg-green-600 transition">üè† –ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="/login" id="loginLink" class="px-3 py-1 rounded hover:bg-green-600 transition">üîë –í—Ö—ñ–¥</a>
      <a href="/register" id="registerLink" class="px-3 py-1 rounded hover:bg-green-600 transition">üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
      <a href="/profile" id="profileLink" class="px-3 py-1 rounded hover:bg-green-600 transition hidden">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</a>
      <a href="/admin" id="adminLink" class="px-3 py-1 rounded hover:bg-green-600 transition hidden">üîß –ê–¥–º—ñ–Ω–∫–∞</a>
      <button onclick="logout()" id="logoutBtn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded hidden">üö™ –í–∏–π—Ç–∏</button>
    </nav>
  </header>  

  <!-- üßæ –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="max-w-4xl mx-auto py-8 px-4">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold text-white">‚öΩ –ù–∞–π–±–ª–∏–∂—á—ñ –º–∞—Ç—á—ñ</h2>
      <button id="createEventBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition hidden">+ –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
    </div>

    <div id="eventsList" class="space-y-6"></div>
    
    <!-- üì∞ –ü–æ—Å—Ç–∏ -->
    <section class="mt-12">
      <h2 class="text-2xl font-semibold text-white mb-4">üì∞ –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ—Å—Ç–∏</h2>
      <div id="postsContainer" class="space-y-8"></div>
    </section>
  </main>

  <!-- üìù –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è -->
  <div id="editEventModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-white text-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl">
      <h2 class="text-xl font-bold mb-4 text-center text-green-800">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ–¥—ñ—é</h2>
      <form id="editEventForm" class="space-y-4">
        <input type="hidden" id="editEventId" />
        <div>
          <label for="editTitle" class="block text-sm font-medium">–ù–∞–∑–≤–∞ –ø–æ–¥—ñ—ó</label>
          <input id="editTitle" class="w-full border rounded px-3 py-2" required />
        </div>
        <div>
          <label for="editLocation" class="block text-sm font-medium">–ú—ñ—Å—Ü–µ</label>
          <input id="editLocation" class="w-full border rounded px-3 py-2" required />
        </div>
        <div>
          <label for="editTime" class="block text-sm font-medium">–ß–∞—Å</label>
          <input id="editTime" type="datetime-local" class="w-full border rounded px-3 py-2" required />
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="closeEditModal" class="bg-gray-300 px-4 py-2 rounded">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------------------------
    // üîπ Helper: fetch wrapper that supports cookie (HttpOnly) + Bearer token fallback
    // ---------------------------
    async function apiFetch(url, opts = {}) {
      // send cookies
      opts.credentials = 'include';
      opts.headers = opts.headers || {};

      // if user stored token in localStorage (for Make/scripts), attach Authorization
      const token = localStorage.getItem('token');
      if (token && !opts.headers['Authorization']) {
        opts.headers['Authorization'] = 'Bearer ' + token;
      }

      // if body is a plain object (not FormData), stringify and set header
      if (opts.body && !(opts.body instanceof FormData) && typeof opts.body !== 'string') {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(opts.body);
      }

      const res = await fetch(url, opts);
      if (!res.ok) {
        // try parse json error
        let errBody = null;
        try { errBody = await res.json(); } catch(e) { errBody = await res.text(); }
        const err = new Error(errBody && errBody.error ? errBody.error : res.statusText);
        err.status = res.status;
        err.body = errBody;
        throw err;
      }
      // Try parse JSON, else return null
      try { return await res.json(); } catch { return null; }
    }

    // ---------------------------
    // üîπ Global state
    // ---------------------------
    window.currentUser = null;

    // ---------------------------
    // üîπ Auth helpers
    // ---------------------------
    async function checkAuth() {
      // try to get current user (this will use cookie or bearer token)
      try {
        const me = await apiFetch('/api/auth/me');
        window.currentUser = me;
        // UI updates
        document.getElementById('loginLink').classList.add('hidden');
        document.getElementById('registerLink').classList.add('hidden');
        document.getElementById('profileLink').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');

        // only admins can access admin panel and create events via UI
        if (me.role === 'admin') {
          document.getElementById('adminLink').classList.remove('hidden');
          document.getElementById('createEventBtn').classList.remove('hidden');
        } else {
          document.getElementById('adminLink').classList.add('hidden');
          document.getElementById('createEventBtn').classList.add('hidden');
        }
      } catch (e) {
        // not logged in ‚Äî keep default
        window.currentUser = null;
        document.getElementById('loginLink').classList.remove('hidden');
        document.getElementById('registerLink').classList.remove('hidden');
        document.getElementById('profileLink').classList.add('hidden');
        document.getElementById('adminLink').classList.add('hidden');
        document.getElementById('createEventBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.add('hidden');
      }
    }

    async function logout() {
      try {
        await apiFetch('/logout', { method: 'POST' });
      } catch (e) {
        // ignore errors
      }
      localStorage.removeItem('token');
      window.currentUser = null;
      // refresh UI
      await checkAuth();
      loadEvents();
      loadPosts();
      window.location.href = '/';
    }

    // ---------------------------
    // üîπ Posts (–∑–±–µ—Ä–µ–∂–µ–Ω–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ axios –±–µ–∑ –∫—É–∫—ñ) 
    // ---------------------------
    function loadPosts() {
      // axios ‚Äî –∑–∞–ª–∏—à–∏–≤ —è–∫ —É —Ç–µ–±–µ, –∞–ª–µ –ø–æ–ø—Ä–æ—Å–∏–º–æ –ø–æ—Å–∏–ª–∞—Ç–∏ –∫—É–∫—ñ —Ç–µ–∂ –Ω–∞ –≤–∏–ø–∞–¥–æ–∫
      axios.defaults.withCredentials = true;
      axios.get('/api/posts')
        .then(response => {
          const posts = response.data;
          const postsContainer = document.getElementById('postsContainer');
          postsContainer.innerHTML = ''; // Clear existing posts
          posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.classList.add('bg-white', 'bg-opacity-10', 'p-4', 'rounded', 'shadow-lg', 'flex', 'gap-4', 'items-start');
            
            const imgElement = document.createElement('img');
            imgElement.src = post.image ? post.image : '/default.jpg';
            imgElement.alt = 'Post Image';
            imgElement.classList.add('w-32', 'h-32', 'object-cover', 'rounded');
            
            const contentElement = document.createElement('div');
            contentElement.innerHTML = `<h3 class="text-lg font-bold">${escapeHtml(post.title)}</h3><p>${escapeHtml(post.content)}</p><p class="text-sm text-gray-300 mt-2">–ê–≤—Ç–æ—Ä: ${escapeHtml(post.author)}</p>`;
            
            postElement.appendChild(imgElement);
            postElement.appendChild(contentElement);
            postsContainer.appendChild(postElement);
          });
        })
        .catch(error => {
          console.error('Error loading posts:', error);
        });
    }

    // ---------------------------
    // üîπ Events
    // ---------------------------
    async function loadEvents() {
      try {
        const events = await apiFetch('/events', { method: 'GET' });
        const list = document.getElementById('eventsList');
        list.innerHTML = '';

        if (!Array.isArray(events) || events.length === 0) {
          list.innerHTML = `<div class="text-gray-300">–ü–æ–¥—ñ–π –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>`;
          return;
        }

        events.forEach(ev => {
          const card = document.createElement('div');
          card.className = 'bg-white bg-opacity-8 rounded p-4 flex gap-4 items-start';

          const left = document.createElement('div');
          left.className = 'w-28 h-28 flex-none';
          const img = document.createElement('img');
          img.className = 'w-28 h-28 object-cover rounded';
          img.src = ev.image ? (ev.image.startsWith('http') ? ev.image : ev.image) : '/default.jpg';
          img.alt = 'Event image';
          left.appendChild(img);

          const body = document.createElement('div');
          body.className = 'flex-1';

          const title = document.createElement('h3');
          title.className = 'text-lg font-bold';
          title.textContent = ev.title;

          const meta = document.createElement('p');
          meta.className = 'text-sm text-gray-200';
          meta.innerHTML = ` <strong>–õ–æ–∫–∞—Ü—ñ—è:</strong> ${escapeHtml(ev.location)} ‚Ä¢ <strong>–ß–∞—Å:</strong> ${escapeHtml(ev.time)} ‚Ä¢ <strong>–°—Ç–≤–æ—Ä–∏–≤:</strong> ${escapeHtml(ev.creator_name || '‚Äî')}`;

          const actions = document.createElement('div');
          actions.className = 'mt-3 flex gap-2';

          // If admin -> show edit/delete
          if (window.currentUser && window.currentUser.role === 'admin') {
            const editBtn = document.createElement('button');
            editBtn.className = 'px-3 py-1 bg-yellow-500 rounded text-black';
            editBtn.textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
            editBtn.onclick = () => openEditModal(ev);
            actions.appendChild(editBtn);

            const delBtn = document.createElement('button');
            delBtn.className = 'px-3 py-1 bg-red-600 rounded';
            delBtn.textContent = '–í–∏–¥–∞–ª–∏—Ç–∏';
            delBtn.onclick = () => deleteEvent(ev.id);
            actions.appendChild(delBtn);
          } else {
            // show Join for logged-in users
            if (window.currentUser) {
              const joinBtn = document.createElement('button');
              joinBtn.className = 'px-3 py-1 bg-green-600 rounded';
              joinBtn.textContent = '–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å';
              joinBtn.onclick = () => joinEvent(ev.id);
              actions.appendChild(joinBtn);
            } else {
              const loginToJoin = document.createElement('a');
              loginToJoin.href = '/login?next=/';
              loginToJoin.className = 'px-3 py-1 bg-gray-600 rounded';
              loginToJoin.textContent = '–£–≤—ñ–π–¥—ñ—Ç—å —â–æ–± –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å';
              actions.appendChild(loginToJoin);
            }
          }

          body.appendChild(title);
          body.appendChild(meta);
          body.appendChild(actions);

          card.appendChild(left);
          card.appendChild(body);
          list.appendChild(card);
        });
      } catch (e) {
        console.error('–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–¥—ñ—ó', e);
        document.getElementById('eventsList').innerHTML = `<div class="text-red-300">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–¥—ñ—ó.</div>`;
      }
    }

    // ---------------------------
    // üîπ Event actions
    // ---------------------------
    async function joinEvent(eventId) {
      try {
        await apiFetch(`/events/${eventId}/join`, { method: 'POST' });
        alert('–í–∏ —É—Å–ø—ñ—à–Ω–æ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è');
      } catch (e) {
        console.error(e);
        alert(e.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è');
      }
    }

    async function deleteEvent(eventId) {
      if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é?')) return;
      try {
        await apiFetch(`/events/${eventId}`, { method: 'DELETE' });
        await loadEvents();
      } catch (e) {
        console.error(e);
        alert(e.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ');
      }
    }

    // ---------------------------
    // üîπ Edit modal
    // ---------------------------
    function openEditModal(ev) {
      document.getElementById('editEventId').value = ev.id;
      document.getElementById('editTitle').value = ev.title;
      document.getElementById('editLocation').value = ev.location;
      // convert time string to datetime-local usable value if possible
      // assuming stored ISO-ish; fallback to empty
      try {
        const d = new Date(ev.time);
        if (!isNaN(d)) {
          const tzOffset = d.getTimezoneOffset() * 60000;
          const localISO = new Date(d.getTime() - tzOffset).toISOString().slice(0,16);
          document.getElementById('editTime').value = localISO;
        } else {
          document.getElementById('editTime').value = '';
        }
      } catch {
        document.getElementById('editTime').value = '';
      }
      document.getElementById('editEventModal').classList.remove('hidden');
    }

    document.getElementById('closeEditModal').addEventListener('click', () => {
      document.getElementById('editEventModal').classList.add('hidden');
    });

    document.getElementById('editEventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editEventId').value;
      const title = document.getElementById('editTitle').value;
      const location = document.getElementById('editLocation').value;
      const time = document.getElementById('editTime').value;

      try {
        await apiFetch(`/events/${id}`, { method: 'PUT', body: { title, location, time } });
        document.getElementById('editEventModal').classList.add('hidden');
        await loadEvents();
      } catch (err) {
        console.error(err);
        alert(err.message || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –ø–æ–¥—ñ—ó');
      }
    });

    // ---------------------------
    // üîπ Utility
    // ---------------------------
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ---------------------------
    // üîπ Init
    // ---------------------------
    document.addEventListener('DOMContentLoaded', async () => {
      // check auth first (so loadEvents can show admin controls)
      await checkAuth();

      // load data
      loadEvents();
      loadPosts();

      // create button (redirect)
      document.getElementById('createEventBtn').addEventListener('click', () => {
        // safe redirect to create page (only admins see the button)
        window.location.href = '/create';
      });
    });
  </script>

</body>
</html>
